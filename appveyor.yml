version: 1.0.{build}

platform:
  - x86
  - x64

configuration:
  - Release
  - Debug

build:
    verbosity: detailed

init:
    - 'echo Building libevent %version% for Windows'
    - 'echo System architecture: %PLATFORM%'
    - 'echo Repo build branch is: %APPVEYOR_REPO_BRANCH%'
    - 'echo Build folder is: %APPVEYOR_BUILD_FOLDER%'

install:
    - set PATH=C:\cygwin\bin;%PATH%;C:\MinGW\msys\1.0\bin;C:\MinGW\bin
    - set CYG_ROOT=C:/MinGW/msys/1.0
    - set OPENSSL_VERSION=1_0_2d
    - ps: >-
        If ($env:Platform -Match "x86") {
            $env:OPENSSL_PLATFORM="Win32"
        } Else {
            $env:OPENSSL_PLATFORM="Win64"
        }
        Start-FileDownload https://slproweb.com/download/Win32OpenSSL-${env:OPENSSL_VERSION}.exe -FileName C:\WinOpenSSL.exe
        C:\WinOpenSSL.exe /SILENT /VERYSILENT /SP- /SUPPRESSMSGBOXES /NORESTART
    - ps: $env:VSCOMNTOOLS=(Get-Content ("env:VS" + "$env:VSVER" + "0COMNTOOLS"))
    - echo "Using Visual Studio %VSVER%.0 at %VSCOMNTOOLS%"

build_script:
    - cmd: 'echo Cygwin root is: %CYG_ROOT%'
    - cmd: 'echo Build folder is: %APPVEYOR_BUILD_FOLDER%'
    - cmd: 'echo Repo build branch is: %APPVEYOR_REPO_BRANCH%'
    - cmd: 'echo Repo build commit is: %APPVEYOR_REPO_COMMIT%'
    - cmd: "echo installing stuff"
    - cmd: 'echo "C:\MinGW /mingw" >%CYG_ROOT%/etc/fstab'
    - cmd: 'C:\MinGW\bin\mingw-get install autotools autoconf automake python'
    - cmd: 'echo Autogen running...'
    - cmd: '%CYG_ROOT%/bin/bash -lc "cd $APPVEYOR_BUILD_FOLDER; exec 0</dev/null;mount C:/MinGW /mingw; bash autoreconf -i; ./configure; make "'

cache:
  - C:\OpenSSL-Win32
  - C:\OpenSSL-Win64

